<!DOCTYPE html>
<html>
<head>
    <title>Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        #controls {
            margin: 20px;
        }
        #passwordModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
        }
    </style>
</head>
<body>
    <div id="passwordModal">
        <div class="modal-content">
            <h2>Enter Password</h2>
            <input type="password" id="passwordInput">
            <button onclick="checkPassword()">Submit</button>
        </div>
    </div>

    <h3>Map</h3>
    <div id="controls">
        <label for="speedRange">Playback Speed (sec): </label>
        <input type="range" id="speedRange" min="10" max="120" value="60" oninput="updateSpeed(this.value)">
        <span id="speedValue">60</span> seconds
        <button onclick="togglePoints()">Show Points</button>
        <button onclick="toggleAnimation()">Start Animation</button>
        <button onclick="toggleRoute()">Show Route</button>
        <button onclick="toggleDriveRoute()">Drive Route</button>
        <br><br>
        <label for="zoomIntensity">Zoom Intensity: </label>
        <input type="range" id="zoomIntensity" min="0" max="10" value="1" oninput="updateZoomIntensity(this.value)">
        <span id="zoomValue">1</span>
        <br><br>
        <label for="startDate">Start Date: </label>
        <input type="date" id="startDate">
        <label for="endDate">End Date: </label>
        <input type="date" id="endDate">
    </div>
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([50.9375, 6.9603], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var routeCoordinates = [];
        var markers = [];
        var totalDuration = 60000;
        var pointDuration;
        var routePath;
        var routeVisible = false;
        var pointsVisible = false;
        var animationRunning = false;
        var currentAnimationIndex = 0;
        var animationTimeout;
        var zoomIntensity = 1;
        var driveRouteRunning = false;
        var vanIcon;

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passwordModal').style.display = 'block';
        });

        function checkPassword() {
            var password = document.getElementById('passwordInput').value;
            if (password === 'thorsten') {
                document.getElementById('passwordModal').style.display = 'none';
                loadData();
            } else {
                alert('Incorrect password');
            }
        }

        function loadData() {
            Papa.parse('https://docs.google.com/spreadsheets/d/13nN8lisfKRQHbD66J2pg1k5jN9lFz15ijwx0obu-03o/pub?gid=0&single=true&output=csv', {
                download: true,
                header: true,
                complete: function(results) {
                    var data = results.data;

                    data.forEach(function(row) {
                        var lat = parseFloat(row.lat);
                        var lon = parseFloat(row.lon);
                        var time = new Date(row.time);

                        if (!isNaN(lat) && !isNaN(lon) && !isNaN(time.getTime())) {
                            routeCoordinates.push({lat: lat, lon: lon, time: time});
                        }
                    });

                    routeCoordinates.sort((a, b) => a.time - b.time);

                    vanIcon = L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/171/171239.png',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                }
            });
        }

        function updateSpeed(value) {
            document.getElementById('speedValue').textContent = value;
            totalDuration = value * 1000;
            if (animationRunning) {
                stopAnimation();
                startAnimation();
            }
        }

        function updateZoomIntensity(value) {
            document.getElementById('zoomValue').textContent = value;
            zoomIntensity = parseInt(value);
        }

        function togglePoints() {
            pointsVisible = !pointsVisible;

            if (pointsVisible) {
                showPoints();
            } else {
                hidePoints();
            }
        }

        function showPoints() {
            hidePoints();
            markers = [];

            routeCoordinates.forEach(function(point) {
                var marker = L.marker([point.lat, point.lon]).addTo(map)
                    .bindPopup(point.time.toLocaleString());
                markers.push(marker);
            });

            map.fitBounds(L.latLngBounds(routeCoordinates.map(point => [point.lat, point.lon])));
        }

        function hidePoints() {
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
        }

        function toggleAnimation() {
            if (animationRunning) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        function startAnimation() {
            hidePoints();
            if (routePath) {
                map.removeLayer(routePath);
            }
            pointDuration = totalDuration / routeCoordinates.length;
            animationRunning = true;
            currentAnimationIndex = 0;
            document.querySelector('button[onclick="toggleAnimation()"]').textContent = "Stop Animation";
            animateRoute(currentAnimationIndex);
        }

        function stopAnimation() {
            animationRunning = false;
            clearTimeout(animationTimeout);
            document.querySelector('button[onclick="toggleAnimation()"]').textContent = "Start Animation";
        }

        function toggleRoute() {
            routeVisible = !routeVisible;
            if (routeVisible) {
                showRoute();
            } else if (routePath) {
                map.removeLayer(routePath);
            }
        }

        function showRoute() {
            if (routePath) {
                map.removeLayer(routePath);
            }
            routePath = L.polyline(routeCoordinates.map(point => [point.lat, point.lon]), {color: 'blue'}).addTo(map);
            map.fitBounds(routePath.getBounds());
        }

        function animateRoute(i) {
            if (i < routeCoordinates.length && animationRunning) {
                var point = routeCoordinates[i];
                var marker = L.marker([point.lat, point.lon]).addTo(map)
                    .bindPopup(point.time.toLocaleString())
                    .openPopup();

                map.setView([point.lat, point.lon], calculateZoom(i));

                currentAnimationIndex = i + 1;
                animationTimeout = setTimeout(function() {
                    map.removeLayer(marker);
                    animateRoute(currentAnimationIndex);
                }, pointDuration);
            } else if (i >= routeCoordinates.length) {
                stopAnimation();
            }
        }

        function calculateZoom(index) {
            if (zoomIntensity === 0) return map.getZoom();
            if (index === 0 || index >= routeCoordinates.length - 1) return map.getZoom();
            
            var prevPoint = routeCoordinates[index - 1];
            var nextPoint = routeCoordinates[index];
            var distance = map.distance([prevPoint.lat, prevPoint.lon], [nextPoint.lat, nextPoint.lon]);

            var baseZoom = 13;
            var zoomAdjustment = (10 - zoomIntensity) * (distance / 200000);

            return Math.max(baseZoom - zoomAdjustment, 5);
        }

        function toggleDriveRoute() {
            if (driveRouteRunning) {
                stopDriveRoute();
            } else {
                startDriveRoute();
            }
        }

        function startDriveRoute() {
            if (routePath) {
                map.removeLayer(routePath);
            }
            routePath = L.polyline([], {color: 'blue'}).addTo(map);
            driveRouteRunning = true;
            document.querySelector('button[onclick="toggleDriveRoute()"]').textContent = "Stop Driving";
            driveRoute(0);
        }

        function stopDriveRoute() {
            driveRouteRunning = false;
            clearTimeout(animationTimeout);
            document.querySelector('button[onclick="toggleDriveRoute()"]').textContent = "Drive Route";
            if (vanMarker) {
                map.removeLayer(vanMarker);
            }
        }

        var vanMarker;

        function driveRoute(i) {
            if (i < routeCoordinates.length - 1 && driveRouteRunning) {
                var start = routeCoordinates[i];
                var end = routeCoordinates[i + 1];
                var duration = end.time - start.time;
                var steps = Math.ceil(duration / 1000); // One step per second

                animateVan(start, end, steps, 0, i);
            } else {
                stopDriveRoute();
            }
        }

        function animateVan(start, end, steps, currentStep, routeIndex) {
            if (currentStep <= steps && driveRouteRunning) {
                var fraction = currentStep / steps;
                var lat = start.lat + (end.lat - start.lat) * fraction;
                var lon = start.lon + (end.lon - start.lon) * fraction;

                if (vanMarker) {
                    vanMarker.setLatLng([lat, lon]);
                } else {
                    vanMarker = L.marker([lat, lon], {icon: vanIcon}).addTo(map);
                }

                routePath.addLatLng([lat, lon]);
                map.setView([lat, lon], calculateZoom(routeIndex));

                animationTimeout = setTimeout(function() {
                    animateVan(start, end, steps, currentStep + 1, routeIndex);
                }, totalDuration / (routeCoordinates.length * steps));
            } else if (driveRouteRunning) {
                driveRoute(routeIndex + 1);
            }
        }
    </script>
</body>
</html>
